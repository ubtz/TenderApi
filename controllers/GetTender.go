package controllers

import (
	"fmt"
	"log"
	"net/http"

	config "TenderApi/conf"

	"github.com/astaxie/beego"
)

type Tender struct {
	TenderId                 int     `json:"tender_id"`
	PlanRootNumber           string  `json:"plan_root_number"`
	TenderName               string  `json:"tender_name"`
	–®–∞–ª–≥–∞—Ä—É—É–ª–∞–ª—Ç—ã–Ω–¢”©—Ä”©–ª      string  `json:"—à–∞–ª–≥–∞—Ä—É—É–ª–∞–ª—Ç—ã–Ω_—Ç”©—Ä”©–ª"`
	–¢–µ–Ω–¥–µ—Ä–∏–π–Ω–î—É–≥–∞–∞—Ä          string  `json:"—Ç–µ–Ω–¥–µ—Ä–∏–π–Ω_–¥—É–≥–∞–∞—Ä"`
	–¢–µ–Ω–¥–µ—Ä–∏–π–Ω–¢”©—Ä”©–ª           string  `json:"—Ç–µ–Ω–¥–µ—Ä–∏–π–Ω_—Ç”©—Ä”©–ª"`
	–ë–∞—Ç–ª–∞–≥–¥—Å–∞–Ω–¢”©—Å”©–≤—Ç”®—Ä—Ç”©–≥    float64 `json:"–±–∞—Ç–ª–∞–≥–¥—Å–∞–Ω_—Ç”©—Å”©–≤—Ç_”©—Ä—Ç”©–≥"`
	–£—Ä–∏–ª–≥–∏–π–Ω–î—É–≥–∞–∞—Ä           string  `json:"—É—Ä–∏–ª–≥–∏–π–Ω_–¥—É–≥–∞–∞—Ä"`
	–£—Ä–∏–ª–≥–∏–π–Ω–û–≥–Ω–æ–æ            string  `json:"—É—Ä–∏–ª–≥–∏–π–Ω_–æ–≥–Ω–æ–æ"`
	“Æ–Ω—ç–ª–≥—ç—ç–•–∏–π—Å—ç–Ω–û–≥–Ω–æ–æ       string  `json:"“Ø–Ω—ç–ª–≥—ç—ç_—Ö–∏–π—Å—ç–Ω_–æ–≥–Ω–æ–æ"`
	–ú—ç–¥—ç–≥–¥—ç–ª–¢–∞—Ä–∞–∞—Å–∞–Ω–û–≥–Ω–æ–æ    string  `json:"–º—ç–¥—ç–≥–¥—ç–ª_—Ç–∞—Ä–∞–∞—Å–∞–Ω_–æ–≥–Ω–æ–æ"`
	–ì—ç—Ä—ç—ç–ë–∞–π–≥—É—É–ª–∞—Ö–≠—Ä—Ö–û–ª–≥–æ—Å–æ–Ω string  `json:"–≥—ç—Ä—ç—ç_–±–∞–π–≥—É—É–ª–∞—Ö_—ç—Ä—Ö_–æ–ª–≥–æ—Å–æ–Ω_–æ–≥–Ω–æ–æ"`
	–ì–æ–º–¥–æ–ª–ì–∞—Ä–≥–∞—Å–∞–Ω–û–≥–Ω–æ–æ      string  `json:"–≥–æ–º–¥–æ–ª_–≥–∞—Ä–≥–∞—Å–∞–Ω_–æ–≥–Ω–æ–æ"`
	–¢“Ø—Ç–≥—ç–ª–∑“Ø“Ø–ª—Å—ç–Ω–û–≥–Ω–æ–æ       string  `json:"—Ç“Ø—Ç–≥—ç–ª–∑“Ø“Ø–ª—Å—ç–Ω_–æ–≥–Ω–æ–æ"`
	–¢–µ–Ω–¥–µ—Ä–ê–º–∂–∏–ª—Ç—Ç–∞–π–ë–æ–ª—Å–æ–Ω    bool    `json:"—Ç–µ–Ω–¥–µ—Ä_–∞–º–∂–∏–ª—Ç—Ç–∞–π_–±–æ–ª—Å–æ–Ω_—ç—Å—ç—Ö"`
	–¢–µ–Ω–¥–µ—Ä–∏–π–Ω–Ø–≤—Ü–®–∞–ª—Ç–≥–∞–∞–Ω     string  `json:"—Ç–µ–Ω–¥–µ—Ä–∏–π–Ω_—è–≤—Ü_—à–∞–ª—Ç–≥–∞–∞–Ω"`
	–¢–∞–π–ª–±–∞—Ä                  string  `json:"—Ç–∞–π–ª–±–∞—Ä"`
	CreatedAt                string  `json:"created_at"`
	CreatedBy                int     `json:"created_by"`
	CreatedByOvog            string  `json:"Ovog"`
	CreatedByNer             string  `json:"Ner"`
	–¢–µ–Ω–¥–µ—Ä–ù—ç—ç—Ö–û–≥–Ω–æ–æ          string  `json:"—Ç–µ–Ω–¥–µ—Ä_–Ω—ç—ç—Ö_–æ–≥–Ω–æ–æ"`
	–¢–µ–Ω–¥–µ—ÄH–•–∞–∞—Ö–û–≥–Ω–æ–æ         string  `json:"—Ç–µ–Ω–¥–µ—Ä_—Ö–∞–∞—Ö_–æ–≥–Ω–æ–æ"`
	–¢–µ–Ω–¥–µ—Ä—Ç–û—Ä–æ–ª—Ü–æ–≥—á          string  `json:"—Ç–µ–Ω–¥–µ—Ä—Ç_–æ—Ä–æ–ª—Ü–æ–≥—á"`
	Organization             string  `json:"Organization"`
	“Æ–î–∞—Ä–≥–∞                   string  `json:"“Ø_–¥–∞—Ä–≥–∞"`
	“Æ–ì–∏—à“Ø“Ø–¥                  string  `json:"“Ø_–≥–∏—à“Ø“Ø–¥"`
	“Æ–î—É–≥–∞–∞—Ä                  string  `json:"“Ø_–¥—É–≥–∞–∞—Ä"`
	“Æ–û–≥–Ω–æ–æ                   string  `json:"“Ø_–æ–≥–Ω–æ–æ"`
	–ó“Æ–ö–î—É–≥–∞–∞—Ä                string  `json:"–∑“Ø–∫_–¥—É–≥–∞–∞—Ä"`
	–ó“Æ–ö–û–≥–Ω–æ–æ                 string  `json:"–∑“Ø–∫_–æ–≥–Ω–æ–æ"`
	BasketIds                string  `json:"basket_ids"`
}

type GetTender struct {
	beego.Controller
}

func (c *GetTender) GetTender() {
	fmt.Println("üì• GetTender endpoint hit")

	cfg := getConfig(config.Env)
	db := connectDB(cfg)
	defer db.Close()

	// üß© Build query depending on environment
	query := `
		SELECT TOP (1000)
			t.TenderId, t.PlanRootNumber, t.TenderName, t.[–®–∞–ª–≥–∞—Ä—É—É–ª–∞–ª—Ç—ã–Ω_—Ç”©—Ä”©–ª],
			t.[–¢–µ–Ω–¥–µ—Ä–∏–π–Ω_–¥—É–≥–∞–∞—Ä], t.[–¢–µ–Ω–¥–µ—Ä–∏–π–Ω_—Ç”©—Ä”©–ª], t.[–ë–∞—Ç–ª–∞–≥–¥—Å–∞–Ω_—Ç”©—Å”©–≤—Ç_”©—Ä—Ç”©–≥],
			t.[–£—Ä–∏–ª–≥–∏–π–Ω_–¥—É–≥–∞–∞—Ä], t.[–£—Ä–∏–ª–≥–∏–π–Ω_–æ–≥–Ω–æ–æ], t.[“Æ–Ω—ç–ª–≥—ç—ç_—Ö–∏–π—Å—ç–Ω_–æ–≥–Ω–æ–æ],
			t.[–ú—ç–¥—ç–≥–¥—ç–ª_—Ç–∞—Ä–∞–∞—Å–∞–Ω_–æ–≥–Ω–æ–æ], t.[–ì—ç—Ä—ç—ç_–±–∞–π–≥—É—É–ª–∞—Ö_—ç—Ä—Ö_–æ–ª–≥–æ—Å–æ–Ω_–æ–≥–Ω–æ–æ],
			t.[–ì–æ–º–¥–æ–ª_–≥–∞—Ä–≥–∞—Å–∞–Ω_–æ–≥–Ω–æ–æ], t.[–¢“Ø—Ç–≥—ç–ª–∑“Ø“Ø–ª—Å—ç–Ω_–æ–≥–Ω–æ–æ],
			t.[–¢–µ–Ω–¥–µ—Ä_–∞–º–∂–∏–ª—Ç—Ç–∞–π_–±–æ–ª—Å–æ–Ω_—ç—Å—ç—Ö], t.[–¢–µ–Ω–¥–µ—Ä–∏–π–Ω_—è–≤—Ü_—à–∞–ª—Ç–≥–∞–∞–Ω],
			t.[–¢–∞–π–ª–±–∞—Ä], t.CreatedAt, t.CreatedBy,
			ISNULL(u.Ovog, '') AS CreatedByOvog,
			ISNULL(u.Ner, '') AS CreatedByNer,
			t.[–¢–µ–Ω–¥–µ—Ä_–Ω—ç—ç—Ö_–æ–≥–Ω–æ–æ], t.[–¢–µ–Ω–¥–µ—Ä_—Ö–∞–∞—Ö_–æ–≥–Ω–æ–æ],
			t.[–¢–µ–Ω–¥–µ—Ä—Ç_–æ—Ä–æ–ª—Ü–æ–≥—á], t.[Organization], t.[“Æ_–î–∞—Ä–≥–∞], t.[“Æ_–ì–∏—à“Ø“Ø–¥],
			t.[“Æ_–î—É–≥–∞–∞—Ä], t.[“Æ_–û–≥–Ω–æ–æ], t.[–ó“Æ–ö_–î—É–≥–∞–∞—Ä], t.[–ó“Æ–ö_–û–≥–Ω–æ–æ], t.[Basket_Ids]
		FROM [Tender].[dbo].[Tender] AS t
		LEFT JOIN [Tender].[dbo].[Users] AS u ON t.CreatedBy = u.Id
		ORDER BY t.TenderId DESC
	`

	if config.Env == "prod" {
		query = `
		SELECT TOP (1000)
			t.TenderId, t.PlanRootNumber, t.TenderName, t.[–®–∞–ª–≥–∞—Ä—É—É–ª–∞–ª—Ç—ã–Ω_—Ç”©—Ä”©–ª],
			t.[–¢–µ–Ω–¥–µ—Ä–∏–π–Ω_–¥—É–≥–∞–∞—Ä], t.[–¢–µ–Ω–¥–µ—Ä–∏–π–Ω_—Ç”©—Ä”©–ª], t.[–ë–∞—Ç–ª–∞–≥–¥—Å–∞–Ω_—Ç”©—Å”©–≤—Ç_”©—Ä—Ç”©–≥],
			t.[–£—Ä–∏–ª–≥–∏–π–Ω_–¥—É–≥–∞–∞—Ä], t.[–£—Ä–∏–ª–≥–∏–π–Ω_–æ–≥–Ω–æ–æ], t.[“Æ–Ω—ç–ª–≥—ç—ç_—Ö–∏–π—Å—ç–Ω_–æ–≥–Ω–æ–æ],
			t.[–ú—ç–¥—ç–≥–¥—ç–ª_—Ç–∞—Ä–∞–∞—Å–∞–Ω_–æ–≥–Ω–æ–æ], t.[–ì—ç—Ä—ç—ç_–±–∞–π–≥—É—É–ª–∞—Ö_—ç—Ä—Ö_–æ–ª–≥–æ—Å–æ–Ω_–æ–≥–Ω–æ–æ],
			t.[–ì–æ–º–¥–æ–ª_–≥–∞—Ä–≥–∞—Å–∞–Ω_–æ–≥–Ω–æ–æ], t.[–¢“Ø—Ç–≥—ç–ª–∑“Ø“Ø–ª—Å—ç–Ω_–æ–≥–Ω–æ–æ],
			t.[–¢–µ–Ω–¥–µ—Ä_–∞–º–∂–∏–ª—Ç—Ç–∞–π_–±–æ–ª—Å–æ–Ω_—ç—Å—ç—Ö], t.[–¢–µ–Ω–¥–µ—Ä–∏–π–Ω_—è–≤—Ü_—à–∞–ª—Ç–≥–∞–∞–Ω],
			t.[–¢–∞–π–ª–±–∞—Ä], t.CreatedAt, t.CreatedBy,
			ISNULL(u.Ovog, '') AS CreatedByOvog,
			ISNULL(u.Ner, '') AS CreatedByNer,
			t.[–¢–µ–Ω–¥–µ—Ä_–Ω—ç—ç—Ö_–æ–≥–Ω–æ–æ], t.[–¢–µ–Ω–¥–µ—Ä_—Ö–∞–∞—Ö_–æ–≥–Ω–æ–æ],
			t.[–¢–µ–Ω–¥–µ—Ä—Ç_–æ—Ä–æ–ª—Ü–æ–≥—á], t.[Organization], t.[“Æ_–î–∞—Ä–≥–∞], t.[“Æ_–ì–∏—à“Ø“Ø–¥],
			t.[“Æ_–î—É–≥–∞–∞—Ä], t.[“Æ_–û–≥–Ω–æ–æ], t.[–ó“Æ–ö_–î—É–≥–∞–∞—Ä], t.[–ó“Æ–ö_–û–≥–Ω–æ–æ], t.[Basket_Ids]
		FROM [Tender].[logtender].[Tender] AS t
		LEFT JOIN [Tender].[logtender].[Users] AS u ON t.CreatedBy = u.Id
		ORDER BY t.TenderId DESC
		`
	}

	rows, err := db.Query(query)
	if err != nil {
		log.Printf("‚ùå Failed to query tenders: %v", err)
		c.Ctx.Output.SetStatus(http.StatusInternalServerError)
		c.Data["json"] = map[string]string{"error": err.Error()}
		c.ServeJSON()
		return
	}
	defer rows.Close()

	var tenders []Tender

	for rows.Next() {
		var t Tender
		err := rows.Scan(
			&t.TenderId,
			&t.PlanRootNumber,
			&t.TenderName,
			&t.–®–∞–ª–≥–∞—Ä—É—É–ª–∞–ª—Ç—ã–Ω–¢”©—Ä”©–ª,
			&t.–¢–µ–Ω–¥–µ—Ä–∏–π–Ω–î—É–≥–∞–∞—Ä,
			&t.–¢–µ–Ω–¥–µ—Ä–∏–π–Ω–¢”©—Ä”©–ª,
			&t.–ë–∞—Ç–ª–∞–≥–¥—Å–∞–Ω–¢”©—Å”©–≤—Ç”®—Ä—Ç”©–≥,
			&t.–£—Ä–∏–ª–≥–∏–π–Ω–î—É–≥–∞–∞—Ä,
			&t.–£—Ä–∏–ª–≥–∏–π–Ω–û–≥–Ω–æ–æ,
			&t.“Æ–Ω—ç–ª–≥—ç—ç–•–∏–π—Å—ç–Ω–û–≥–Ω–æ–æ,
			&t.–ú—ç–¥—ç–≥–¥—ç–ª–¢–∞—Ä–∞–∞—Å–∞–Ω–û–≥–Ω–æ–æ,
			&t.–ì—ç—Ä—ç—ç–ë–∞–π–≥—É—É–ª–∞—Ö–≠—Ä—Ö–û–ª–≥–æ—Å–æ–Ω,
			&t.–ì–æ–º–¥–æ–ª–ì–∞—Ä–≥–∞—Å–∞–Ω–û–≥–Ω–æ–æ,
			&t.–¢“Ø—Ç–≥—ç–ª–∑“Ø“Ø–ª—Å—ç–Ω–û–≥–Ω–æ–æ,
			&t.–¢–µ–Ω–¥–µ—Ä–ê–º–∂–∏–ª—Ç—Ç–∞–π–ë–æ–ª—Å–æ–Ω,
			&t.–¢–µ–Ω–¥–µ—Ä–∏–π–Ω–Ø–≤—Ü–®–∞–ª—Ç–≥–∞–∞–Ω,
			&t.–¢–∞–π–ª–±–∞—Ä,
			&t.CreatedAt,
			&t.CreatedBy,
			&t.CreatedByOvog,
			&t.CreatedByNer,
			&t.–¢–µ–Ω–¥–µ—Ä–ù—ç—ç—Ö–û–≥–Ω–æ–æ,
			&t.–¢–µ–Ω–¥–µ—ÄH–•–∞–∞—Ö–û–≥–Ω–æ–æ,
			&t.–¢–µ–Ω–¥–µ—Ä—Ç–û—Ä–æ–ª—Ü–æ–≥—á,
			&t.Organization,
			&t.“Æ–î–∞—Ä–≥–∞,
			&t.“Æ–ì–∏—à“Ø“Ø–¥,
			&t.“Æ–î—É–≥–∞–∞—Ä,
			&t.“Æ–û–≥–Ω–æ–æ,
			&t.–ó“Æ–ö–î—É–≥–∞–∞—Ä,
			&t.–ó“Æ–ö–û–≥–Ω–æ–æ,
			&t.BasketIds,
		)
		if err != nil {
			log.Printf("‚ùå Row scan error: %v", err)
			continue
		}
		tenders = append(tenders, t)
	}

	c.Data["json"] = tenders
	c.ServeJSON()
}
